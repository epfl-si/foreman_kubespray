<%#
name: Ansible Playbook - Kubespray
description_format: Invoke Kubespray's main playbook (cluster.yml) on a host group
snippet: false
kind: job_template
model: JobTemplate
job_category: Ansible Playbook
provider_type: Ansible
feature: kubespray_run
%>

---
- name: Prepare inventory
  hosts: localhost
  tasks:
    # The cwd is something like /tmp/d20210307-18-np2moy/project
    #
    # The directory layout under /tmp/d20210307-18-np2moy looks like
    #
    # data            # The inventory from Foreman, in JSON
    # inventory/
    #   hosts         # A weird executable script generated by foreman_ansible_core's
    #                 # ForemanAnsibleCore::Runner::AnsibleRunner, that just `cat`s
    #                 # the `data` JSON file
    # project/
    #   playbook.yml  # This here template ends up there

    - name: Read inventory
      shell: cat ../data
      register: _inventory

    - name: Parse inventory
      set_fact:
        _foreman_inventory: "{{ _inventory.stdout | from_json }}"

    - name: Augment inventory with groups
      copy:
        dest: ../inventory/hosts
        mode: "0644"
        content: |
          all:
            children:
              k8s-cluster:
                hosts:
          {% for host in hostvars %}
                  {{ host }}:
                    {{ _foreman_inventory["_meta"]["hostvars"][host] | to_yaml |
                       regex_replace('(?m)^kubespray_') | indent(width=10) }}
          {% endfor %}
              # https://github.com/kubernetes-sigs/kubespray/blob/master/docs/ansible.md#inventory
              kube-node:
                hosts: {{
                  kube_nodes      | trim | default('{}', true) | from_yaml | to_json }}
              kube-master:
                hosts: {{
                  kube_masters    | trim | default('{}', true) | from_yaml | to_json }}
              etcd:
                hosts: {{
                  etcd_nodes      | trim | default('{}', true) | from_yaml | to_json }}
              calico-rr:
                hosts: {{
                  calico_rr_nodes | trim | default('{}', true) | from_yaml | to_json }}
      vars:
        hostvars: >-
          {{ _foreman_inventory["_meta"]["hostvars"] }}
        kube_nodes: |
          {% for host in hostvars %}
          {% if hostvars[host].kubespray_is_kube_node | default(False) %}
          {{ host }}: {}
          {% endif %}
          {% endfor %}
        kube_masters: |
          {% for host in hostvars %}
          {% if hostvars[host].kubespray_is_kube_master | default(False) %}
          {{ host }}: {}
          {% endif %}
          {% endfor %}
        etcd_nodes: |
          {% for host in hostvars %}
          {% if ( (hostvars[host].kubespray_etcd_member_name is defined) and
                            (hostvars[host].kubespray_etcd_member_name | length > 0) ) %}
          {{ host }}: {}
          {% endif %}
          {% endfor %}
        calico_rr_nodes: |
          {% for host in hostvars %}
          {% if hostvars[host].kubespray_is_calico_rr | default(False) %}
          {{ host }}: {}
          {% endif %}
          {% endfor %}

    - name: Re-read inventory
      meta: refresh_inventory

- name: Run Kubespray
  import_playbook: /usr/share/kubespray/cluster.yml
